{% extends "base/base.html" %}

{% block title %} Reporting Dashboard {% endblock %}

{% block content %}
<!-- Custom Message Box -->

<section class="hero-section container">

    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="messageBoxContent" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="messageBoxClose" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">OK</button>
        </div>
    </div>

    <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg my-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Reporting Dashboard</h1>

        <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-8 mb-8">
            <label class="inline-flex items-center">
                <input type="radio" class="form-radio h-5 w-5 text-indigo-600" name="reportOption" value="dateRange" checked id="radioDateRange">
                <span class="ml-2 text-lg text-gray-700">Search by Date Range</span>
            </label>
            <label class="inline-flex items-center">
                <input type="radio" class="form-radio h-5 w-5 text-indigo-600" name="reportOption" value="billCycle" id="radioBillCycle">
                <span class="ml-2 text-lg text-gray-700">Prioritize by Bill Cycle</span>
            </label>
        </div>

        <!-- Date Range Search Section -->
        <div id="dateRangeSection" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Search by Date Range</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date:</label>
                    <input type="date" id="startDate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date:</label>
                    <input type="date" id="endDate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="searchButton" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Search
                </button>
            </div>
        </div>

        <!-- Bill Cycle Prioritization Section -->
        <div id="billCycleSection" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Prioritize by Bill Cycle</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                <div>
                    <label for="billCycleSelect" class="block text-sm font-medium text-gray-700 mb-1">Select Bill Cycle:</label>
                    <select id="billCycleSelect" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">-- Select --</option>
                        <option value="1">1</option>
                        <option value="4">4</option>
                        <option value="7">7</option>
                        <option value="10">10</option>
                        <option value="13">13</option>
                        <option value="16">16</option>
                        <option value="19">19</option>
                        <option value="22">22</option>
                        <option value="25">25</option>
                        <option value="28">28</option>
                    </select>
                </div>
                <div class="md:col-span-1"></div>
            </div>
            <div class="mt-6 text-center">
                <button id="searchBillCycleButton" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Search
                </button>
            </div>
        </div>

        <!-- Reporting Table -->
        <div id="reportingTableContainer" class="overflow-x-auto shadow-md rounded-lg hidden">
            <table id="reportingTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-600 text-white">
                    <!-- Table headers will be dynamically inserted here by JavaScript -->
                </thead>
                <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Table rows will be dynamically inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

</section>

{% endblock %}

{% block extra_script %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    const radioDateRange = document.getElementById('radioDateRange');
    const radioBillCycle = document.getElementById('radioBillCycle');
    const dateRangeSection = document.getElementById('dateRangeSection');
    const billCycleSection = document.getElementById('billCycleSection');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const searchButton = document.getElementById('searchButton');
    const billCycleSelect = document.getElementById('billCycleSelect');
    const searchBillCycleButton = document.getElementById('searchBillCycleButton');
    const reportingTableContainer = document.getElementById('reportingTableContainer');
    const tableBody = document.getElementById('tableBody');
    const messageBox = document.getElementById('messageBox');
    const messageBoxContent = document.getElementById('messageBoxContent');
    const messageBoxClose = document.getElementById('messageBoxClose');

    let currentSortColumn = null;
    let currentSortDirection = 'asc';
    let currentMode = 'dateRange'; // Tracks the currently active display mode

    // Dummy Data (extended to include new fields for bill cycle prioritization)
    let tableData = [
        {
            messageRequestId: '111111', status: 'Submitted', projectTitle: 'Consumer - Bend Notice (Fake)',
            projectOwner: 'John Smith', projectType: 'Bill Message', category: 'GRA',
            startDate: '2025-06-01', endDate: '2025-07-01', targetingType: 'Criteria Targeting',
            projectPlacement: 'Top', categoryRank: 1, priority: true, lastModifiedBy: 'Admin A'
        },
        {
            messageRequestId: '222222', status: 'Submitted', projectTitle: 'Commercial - Customer Notice (Fake)',
            projectOwner: 'Jane Smith', projectType: 'Bill Onsert', category: 'Customer',
            startDate: '2025-05-01', endDate: '2025-07-01', targetingType: 'List Targeting',
            projectPlacement: 'Middle', categoryRank: 2, priority: false, lastModifiedBy: 'Admin B'
        },
        {
            messageRequestId: '333333', status: 'Saved', projectTitle: 'Consumer - St George - Mobile Rollout (Fake)',
            projectOwner: 'Jackie Smith', projectType: 'Bill Onsert', category: 'Marketing',
            startDate: '2025-07-01', endDate: '2025-09-01', targetingType: 'List Targeting',
            projectPlacement: 'Bottom', categoryRank: 3, priority: true, lastModifiedBy: 'Admin C'
        },
        {
            messageRequestId: '444444', status: 'Pending', projectTitle: 'Internal - System Update (Fake)',
            projectOwner: 'Alice Brown', projectType: 'System Alert', category: 'IT',
            startDate: '2025-08-15', endDate: '2025-08-30', targetingType: 'All Users',
            projectPlacement: 'Middle', categoryRank: 4, priority: false, lastModifiedBy: 'Admin A'
        },
        {
            messageRequestId: '555555', status: 'Approved', projectTitle: 'Holiday Promotion (Fake)',
            projectOwner: 'Bob Johnson', projectType: 'Marketing Campaign', category: 'Sales',
            startDate: '2025-09-01', endDate: '2025-10-15', targetingType: 'Customer Segment',
            projectPlacement: 'Top', categoryRank: 1, priority: true, lastModifiedBy: 'Admin B'
        }
    ];

    // Column definitions for each mode
    const dateRangeColumns = [
        { key: 'messageRequestId', label: 'Message Request ID', sortable: true, filterable: true },
        { key: 'status', label: 'Status', sortable: true, filterable: true },
        { key: 'projectTitle', label: 'Project Title', sortable: true, filterable: true },
        { key: 'projectOwner', label: 'Project Owner', sortable: true, filterable: true },
        { key: 'projectType', label: 'Project Type', sortable: true, filterable: true },
        { key: 'category', label: 'Category', sortable: true, filterable: true },
        { key: 'startDate', label: 'Start Date', sortable: true, filterable: true },
        { key: 'endDate', label: 'End Date', sortable: true, filterable: true },
        { key: 'targetingType', label: 'Targeting Type', sortable: true, filterable: true }
    ];

    const billCycleColumns = [
        { key: 'projectPlacement', label: 'Project Placement', sortable: true, filterable: true },
        { key: 'categoryRank', label: 'Category Rank', sortable: true, filterable: true, editable: true, type: 'text' },
        { key: 'priority', label: 'Priority', sortable: true, filterable: false, editable: true, type: 'checkbox' },
        { key: 'messageRequestId', label: 'Project ID', sortable: true, filterable: true, link: true },
        { key: 'projectTitle', label: 'Project Title', sortable: true, filterable: true },
        { key: 'projectOwner', label: 'Project Owner', sortable: true, filterable: true },
        { key: 'projectType', label: 'Project Type', sortable: true, filterable: true },
        { key: 'category', label: 'Category', sortable: true, filterable: true },
        { key: 'startDate', label: 'Start Date', sortable: true, filterable: true },
        { key: 'endDate', label: 'End Date', sortable: true, filterable: true },
        { key: 'lastModifiedBy', label: 'Last Modified By', sortable: true, filterable: true }
    ];

    // --- Message Box Functions ---
    function showMessageBox(message) {
        messageBoxContent.textContent = message;
        messageBox.classList.remove('hidden');
    }

    messageBoxClose.addEventListener('click', () => {
        messageBox.classList.add('hidden');
    });

    // --- Table Rendering and Logic ---

    function renderTable(dataToRender, mode) {
        currentMode = mode;
        const tableHead = document.querySelector('#reportingTable thead');
        tableBody.innerHTML = '';
        tableHead.innerHTML = '';

        const columns = (mode === 'dateRange') ? dateRangeColumns : billCycleColumns;

        // Render Table Header
        const headerRow = document.createElement('tr');
        columns.forEach(col => {
            const th = document.createElement('th');
            th.className = 'px-6 py-3 text-left text-xs font-bold uppercase tracking-wider cursor-pointer';
            th.setAttribute('data-column', col.key);
            th.textContent = col.label;

            if (col.filterable) {
                const filterWrapper = document.createElement('div');
                filterWrapper.className = 'filter-input-wrapper mt-1';
                const filterInput = document.createElement('input');
                filterInput.type = 'text';
                filterInput.placeholder = `Filter ${col.label.split(' ')[0]}`;
                filterInput.className = 'column-filter w-full px-2 py-1 text-gray-800 text-sm rounded-sm focus:outline-none focus:ring-1 focus:ring-indigo-300';
                filterInput.setAttribute('data-column-key', col.key);
                filterWrapper.appendChild(filterInput);
                th.appendChild(filterWrapper);

                filterInput.addEventListener('keyup', () => {
                    applyFiltersAndSort();
                });
                filterInput.addEventListener('click', (e) => e.stopPropagation());
            }
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        document.querySelectorAll('#reportingTable thead th').forEach(header => {
            const columnName = header.dataset.column;
            if (columnName) {
                header.addEventListener('click', (event) => {
                    if (!event.target.classList.contains('column-filter')) {
                        sortTableData(columnName);
                    }
                });
            }
        });

        // Render Table Body
        if (dataToRender.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${columns.length}" class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-500">No data found for the selected criteria.</td></tr>`;
            return;
        }

        dataToRender.forEach((rowData, rowIndex) => {
            const row = document.createElement('tr');
            row.className = rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';

            columns.forEach(col => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';

                if (col.editable) {
                    if (col.type === 'text') {
                        const span = document.createElement('span');
                        span.contentEditable = true;
                        span.textContent = rowData[col.key];
                        span.className = 'editable-text block focus:outline-none focus:ring-1 focus:ring-indigo-300 rounded px-1 -mx-1';
                        span.setAttribute('data-row-index', rowIndex);
                        span.setAttribute('data-column-key', col.key);
                        span.addEventListener('blur', (e) => {
                            const updatedValue = e.target.textContent;
                            const rIndex = parseInt(e.target.dataset.rowIndex);
                            const cKey = e.target.dataset.columnKey;
                            tableData[rIndex][cKey] = updatedValue;
                        });
                        td.appendChild(span);
                    } else if (col.type === 'checkbox') {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = rowData[col.key];
                        checkbox.className = 'form-checkbox h-4 w-4 text-indigo-600 rounded';
                        checkbox.setAttribute('data-row-index', rowIndex);
                        checkbox.setAttribute('data-column-key', col.key);
                        checkbox.addEventListener('change', (e) => {
                            const updatedValue = e.target.checked;
                            const rIndex = parseInt(e.target.dataset.rowIndex);
                            const cKey = e.target.dataset.columnKey;
                            tableData[rIndex][cKey] = updatedValue;
                        });
                        td.appendChild(checkbox);
                    }
                } else if (col.link) {
                    const link = document.createElement('a');
                    link.href = `/project-request/${rowData[col.key]}`;
                    link.textContent = rowData[col.key];
                    link.className = 'text-indigo-600 hover:underline';
                    td.appendChild(link);
                } else {
                    td.textContent = rowData[col.key];
                }
                row.appendChild(td);
            });
            tableBody.appendChild(row);
        });
    }

    function applyFiltersAndSort() {
        let data = [...tableData];

        document.querySelectorAll('.column-filter').forEach(filterInput => {
            const filterValue = filterInput.value.toLowerCase().trim();
            const columnName = filterInput.dataset.columnKey;

            if (filterValue && columnName) {
                data = data.filter(row => {
                    const cellValue = String(row[columnName]).toLowerCase();
                    return cellValue.includes(filterValue);
                });
            }
        });

        if (currentSortColumn) {
            data.sort((a, b) => {
                const valA = String(a[currentSortColumn]).toLowerCase();
                const valB = String(b[currentSortColumn]).toLowerCase();

                if (valA < valB) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }
        renderTable(data, currentMode);
    }

    function sortTableData(column) {
        if (currentSortColumn === column) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = column;
            currentSortDirection = 'asc';
        }
        applyFiltersAndSort();
    }

    // --- Event Listeners ---

    document.querySelectorAll('input[name="reportOption"]').forEach(radio => {
        radio.addEventListener('change', (event) => {
            document.querySelectorAll('.column-filter').forEach(input => input.value = '');
            currentSortColumn = null;
            currentSortDirection = 'asc';

            if (event.target.value === 'dateRange') {
                dateRangeSection.classList.remove('hidden');
                billCycleSection.classList.add('hidden');
                reportingTableContainer.classList.add('hidden');
            } else {
                dateRangeSection.classList.add('hidden');
                billCycleSection.classList.remove('hidden');
                reportingTableContainer.classList.add('hidden');
            }
        });
    });

    searchButton.addEventListener('click', () => {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        if (!startDate || !endDate) {
            showMessageBox('Please select both start and end dates.');
            return;
        }

        let filteredByDate = tableData.filter(row => {
            return row.startDate >= startDate && row.endDate <= endDate;
        });
        
        reportingTableContainer.classList.remove('hidden');
        renderTable(filteredByDate, 'dateRange');
    });

    searchBillCycleButton.addEventListener('click', () => {
        const selectedBillCycle = billCycleSelect.value;

        if (!selectedBillCycle) {
            showMessageBox('Please select a Bill Cycle.');
            return;
        }

        // Simulate fetching data based on bill cycle
        // In a real application, you would make an AJAX call to your Django backend here,
        // passing the selectedBillCycle, and your Django view would query the Oracle package.
        // For demonstration, we'll filter dummy data based on a placeholder condition.
        let filteredByBillCycle = tableData.filter(row => {
            // Example: filter based on a dummy condition related to bill cycle,
            // or simply display all data if the Oracle package handles the specific filtering.
            // For this demo, let's just show all data with the new columns.
            return true; // Replace with actual filtering logic based on selectedBillCycle
        });

        reportingTableContainer.classList.remove('hidden');
        renderTable(filteredByBillCycle, 'billCycle');
    });
</script>

{% endblock %}